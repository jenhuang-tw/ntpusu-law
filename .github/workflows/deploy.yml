# GitHub Actions å·¥ä½œæµç¨‹ï¼šè‡ªå‹•ç”Ÿæˆæ¸…å–®ä¸¦éƒ¨ç½²åˆ° GitHub Pages
# æª”æ¡ˆä½ç½®ï¼š.github/workflows/deploy.yml
# ç”¨é€”ï¼šç•¶ç¨‹å¼ç¢¼æ¨é€åˆ°ä¸»åˆ†æ”¯æ™‚ï¼Œè‡ªå‹•åŸ·è¡Œæ¸…å–®ç”Ÿæˆå’Œç¶²ç«™éƒ¨ç½²

name: ç”Ÿæˆæ–‡ä»¶æ¸…å–®ä¸¦éƒ¨ç½²åˆ° GitHub Pages

# è§¸ç™¼æ¢ä»¶ï¼šç•¶æ¨é€åˆ° main åˆ†æ”¯æˆ–æ‰‹å‹•è§¸ç™¼æ™‚åŸ·è¡Œ
on:
  push:
    branches: [ main, master ]  # æ”¯æ´ main æˆ– master åˆ†æ”¯
    paths:
      - 'file/**'  # ç•¶ file ç›®éŒ„æœ‰è®Šæ›´æ™‚è§¸ç™¼
      - 'generate-manifest.py'  # ç•¶ç”Ÿæˆè…³æœ¬æœ‰è®Šæ›´æ™‚è§¸ç™¼
      - '.github/workflows/deploy.yml'  # ç•¶å·¥ä½œæµç¨‹æª”æ¡ˆæœ‰è®Šæ›´æ™‚è§¸ç™¼
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

# è¨­å®šå·¥ä½œæµç¨‹æ¬Šé™ - é‡è¦ï¼šç¢ºä¿æ‰€æœ‰å¿…è¦æ¬Šé™éƒ½å·²è¨­å®š
permissions:
  contents: write      # å…è¨±å¯«å…¥å…§å®¹ï¼ˆæäº¤è®Šæ›´ï¼‰
  pages: write         # å…è¨±éƒ¨ç½²åˆ° Pages
  id-token: write      # å…è¨± OIDC é©—è­‰
  actions: read        # å…è¨±è®€å– Actions è³‡è¨Š
  deployments: write   # å…è¨±å»ºç«‹éƒ¨ç½²

# è¨­å®šä¸¦ç™¼æ§åˆ¶ï¼Œé¿å…åŒæ™‚éƒ¨ç½²é€ æˆè¡çª
concurrency:
  group: "pages"
  cancel-in-progress: false

# å·¥ä½œæµç¨‹ä»»å‹™
jobs:
  # ä»»å‹™ 1ï¼šç”Ÿæˆæ¸…å–®ä¸¦æ§‹å»º
  build:
    name: ç”Ÿæˆæ–‡ä»¶æ¸…å–®ä¸¦æ§‹å»º
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥é©Ÿ 1ï¼šæª¢å‡ºç¨‹å¼ç¢¼
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å–å¾—å®Œæ•´çš„ Git æ­·å²è¨˜éŒ„
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # æ­¥é©Ÿ 2ï¼šè¨­å®š Python ç’°å¢ƒ
    - name: è¨­å®š Python ç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # ä½¿ç”¨ Python 3.9
    
    # æ­¥é©Ÿ 3ï¼šæª¢æŸ¥ file ç›®éŒ„æ˜¯å¦å­˜åœ¨
    - name: æª¢æŸ¥ file ç›®éŒ„
      run: |
        echo "æª¢æŸ¥ file ç›®éŒ„æ˜¯å¦å­˜åœ¨..."
        if [ ! -d "file" ]; then
          echo "è­¦å‘Šï¼šfile ç›®éŒ„ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹ç©ºç›®éŒ„"
          mkdir -p file
        else
          echo "file ç›®éŒ„å­˜åœ¨ï¼Œå…§å®¹å¦‚ä¸‹ï¼š"
          ls -la file/
        fi
    
    # æ­¥é©Ÿ 4ï¼šåŸ·è¡Œæ¸…å–®ç”Ÿæˆè…³æœ¬
    - name: åŸ·è¡Œæ¸…å–®ç”Ÿæˆè…³æœ¬
      run: |
        echo "é–‹å§‹åŸ·è¡Œæ–‡ä»¶æ¸…å–®ç”Ÿæˆ..."
        python generate-manifest.py
        
        echo "æª¢æŸ¥ç”Ÿæˆçµæœ..."
        if [ -f "file/manifest.json" ]; then
          echo "âœ… manifest.json ç”ŸæˆæˆåŠŸ"
          echo "æª”æ¡ˆå…§å®¹ï¼š"
          cat file/manifest.json
        else
          echo "âŒ manifest.json ç”Ÿæˆå¤±æ•—"
          exit 1
        fi
    
    # æ­¥é©Ÿ 5ï¼šæª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
    - name: æª¢æŸ¥è®Šæ›´
      id: check-changes
      run: |
        echo "æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "æ²’æœ‰æª”æ¡ˆè®Šæ›´ï¼Œè·³éæäº¤æ­¥é©Ÿ"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "ç™¼ç¾æª”æ¡ˆè®Šæ›´ï¼Œæº–å‚™æäº¤"
          echo "changes=true" >> $GITHUB_OUTPUT
          git status
        fi
    
    # æ­¥é©Ÿ 6ï¼šæäº¤è®Šæ›´ï¼ˆåªæœ‰åœ¨æœ‰è®Šæ›´æ™‚åŸ·è¡Œï¼‰
    - name: æäº¤è®Šæ›´
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "æäº¤ manifest.json è®Šæ›´..."
        git add file/manifest.json
        git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°æ–‡ä»¶æ¸…å–® (manifest.json)
        
        - ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ
        - æäº¤æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S')
        - è§¸ç™¼åˆ†æ”¯: ${{ github.ref_name }}
        - æäº¤é›œæ¹Š: ${{ github.sha }}"
    
    # æ­¥é©Ÿ 7ï¼šæ¨é€è®Šæ›´ï¼ˆåªæœ‰åœ¨æœ‰è®Šæ›´æ™‚åŸ·è¡Œï¼‰
    - name: æ¨é€è®Šæ›´
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        echo "æ¨é€è®Šæ›´åˆ°é ç«¯å„²å­˜åº«..."
        git push origin ${{ github.ref_name }}
        echo "âœ… è®Šæ›´æ¨é€å®Œæˆ"
    
    # æ­¥é©Ÿ 8ï¼šè¨­å®š GitHub Pages é…ç½®
    - name: è¨­å®š Pages é…ç½®
      uses: actions/configure-pages@v4
    
    # æ­¥é©Ÿ 9ï¼šä¸Šå‚³æ§‹å»ºç”¢ç‰©ï¼ˆç”¨æ–¼éƒ¨ç½²ï¼‰
    - name: ä¸Šå‚³é é¢æ§‹å»ºç”¢ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: .  # ä¸Šå‚³æ•´å€‹å°ˆæ¡ˆç›®éŒ„

  # ä»»å‹™ 2ï¼šéƒ¨ç½²åˆ° GitHub Pages
  deploy:
    name: éƒ¨ç½²åˆ° GitHub Pages
    needs: build  # ä¾è³´æ–¼æ§‹å»ºä»»å‹™
    runs-on: ubuntu-latest
    
    # è¨­å®š GitHub Pages ç’°å¢ƒ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # æ­¥é©Ÿ 1ï¼šéƒ¨ç½²åˆ° GitHub Pages
    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4  # ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬